<!DOCTYPE html>
<html lang="ko">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<head>
  <meta charset="UTF-8" />
  <title>ê³¼íƒ‘ì˜ ë¹„ë°€ ë…¸íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… jsPDFë¥¼ head ì•ˆìœ¼ë¡œ -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- âœ… í°íŠ¸ base64 ìŠ¤í¬ë¦½íŠ¸ë„ headì—ì„œ deferë¡œ -->
  <script defer src="./NanumGothic.base64.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Apple SD Gothic Neo",
        "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at top left, #ffe0f7, #e3f2ff 40%, #f5f5ff 80%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      color: #222;
    }

    .app-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 32px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      padding: 32px 28px 28px;
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      text-align: center;
    }

    header h1 {
      font-size: 2.6rem;
      line-height: 1.2;
      letter-spacing: 0.08em;
      font-weight: 800;
      color: #ff66a2;
      text-shadow: 0 4px 0 #ffd1e6;
    }

    header h1 span {
      display: inline-block;
      padding: 4px 14px;
      border-radius: 999px;
      background: #fff6fb;
      border: 2px solid #ffb6d9;
      margin-top: 8px;
      font-size: 1rem;
      color: #ff5b8b;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .card {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 18px;
      flex: 1 1 260px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.04);
      border: 1px solid #f2e9ff;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fdf0ff;
      color: #b055ff;
      border: 1px solid #e2c5ff;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #444;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      border-radius: 12px;
      border: 1px solid #e0d4ff;
      padding: 8px 10px;
      font-size: 0.9rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #fdfcff;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      border-color: #b388ff;
      box-shadow: 0 0 0 2px rgba(179, 136, 255, 0.25);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .file-input-wrapper input[type="file"] {
      font-size: 0.8rem;
    }

    .file-name {
      font-size: 0.8rem;
      color: #777;
    }

    .question-types {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 16px;
      background: #f6f7ff;
      border: 1px dashed #c3c7ff;
    }

    .question-types label {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }

    .question-types input[type="radio"] {
      accent-color: #b388ff;
    }

    .bottom-card {
      border-radius: 24px;
    }

    .output-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .output-box {
      flex: 1 1 260px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .output-box h2 {
      font-size: 0.95rem;
      font-weight: 700;
      color: #444;
    }

    .output-box textarea {
      min-height: 150px;
      background: #faf7ff;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
      margin-bottom: 2px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff8fb1, #ff66a2);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(255, 102, 162, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(255, 102, 162, 0.45);
    }

    .btn-secondary {
      background: #f4f4ff;
      color: #555;
      border: 1px solid #d2d2ff;
    }

    .btn-secondary:hover {
      background: #ececff;
    }

    .helper-text {
      font-size: 0.75rem;
      color: #888;
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 24px 18px 20px;
        border-radius: 24px;
      }

      header h1 {
        font-size: 2.1rem;
      }

      .controls {
        justify-content: center;
        flex-wrap: wrap;
      }
    }

      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      
      .btn-icon {
        border: none;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        background: #f4f4ff;
        color: #555;
        border: 1px solid #d2d2ff;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      
      .btn-icon:hover {
        background: #ececff;
      }
    
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>ê³¼íƒ‘ì˜ ë¹„ë°€ ë…¸íŠ¸<br /><span>Lecture Note &amp; Quiz Generator</span></h1>
    </header>

    <main>
      <form id="noteForm" onsubmit="register(event)">
        <!-- ìƒë‹¨: ì™¼ìª½ / ì˜¤ë¥¸ìª½ ë°•ìŠ¤ -->
        <div class="top-row">
          <!-- ì™¼ìª½ ë‘¥ê·¼ ë„¤ëª¨ ë°•ìŠ¤ -->
          <section class="card">
            <div class="card-title">
              âœï¸ ì…ë ¥ 1
              <span class="badge">ê³¼ëª© &amp; ê°•ì˜ìë£Œ</span>
            </div>

            <div class="form-group">
              <label for="subjectName">ê³¼ëª© ì´ë¦„</label>
              <input
                type="text"
                id="subjectName"
                placeholder="ì˜ˆ: ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬"
                required
              />
            </div>

            <div class="form-group">
              <label for="profStyle">êµìˆ˜ë‹˜ ìŠ¤íƒ€ì¼ / íŠ¹ì´ì‚¬í•­</label>
              <textarea
                id="profStyle"
                placeholder="ì˜ˆ: ê³„ì‚° ë¬¸ì œ ë¹„ìœ¨ ë†’ìŒ, ì¦ëª… ì¢‹ì•„í•˜ì‹¬, ì˜ˆì œ ì„¤ëª… ìœ„ì£¼ ë“±"
              ></textarea>
              <p class="helper-text">
                êµìˆ˜ë‹˜ì´ ì„ í˜¸í•˜ëŠ” ë¬¸ì œ ìœ í˜•, ìì£¼ ê°•ì¡°í•˜ëŠ” í‘œí˜„ ë“±ì„ ì ì–´ ì£¼ì„¸ìš”.
              </p>
            </div>

            <div class="form-group">
              <label for="lectureFile">ê°•ì˜ìë£Œ ì—…ë¡œë“œ</label>
              <div class="file-input-wrapper">
                <input
                  type="file"
                  id="lectureFile"
                  accept=".pdf,.ppt,.pptx,.doc,.docx,.txt"
                />
                <span id="fileName" class="file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
              </div>
              <p class="helper-text">
                ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì´ íŒŒì¼ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë…¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
              </p>
            </div>
          </section>

          <!-- ì˜¤ë¥¸ìª½ ë‘¥ê·¼ ë„¤ëª¨ ë°•ìŠ¤ -->
          <section class="card">
            <div class="card-title">
              ğŸ“œ ì…ë ¥ 2
              <span class="badge">ë¬¸ì œ ì„¤ì •</span>
            </div>

            <div class="form-group">
              <label for="questionCount">ë¬¸ì œ ìˆ˜</label>
              <input
                type="number"
                id="questionCount"
                min="1"
                max="50"
                value="5"
                required
              />
              <p class="helper-text">
                ìƒì„±í•  ì—°ìŠµ ë¬¸ì œ ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (1~50)
              </p>
            </div>

            <div class="form-group">
              <label>ë¬¸ì œ ìœ í˜•</label>
              <div class="question-types">
                <label>
                  <input
                    type="radio"
                    name="questionType"
                    value="ê°ê´€ì‹"
                    checked
                  />
                  ê°ê´€ì‹
                </label>
                <label>
                  <input type="radio" name="questionType" value="ë‹¨ë‹µì‹" />
                  ë‹¨ë‹µì‹
                </label>
                <label>
                  <input type="radio" name="questionType" value="ì„œìˆ í˜•" />
                  ì„œìˆ í˜•
                </label>
                <label>
                  <input type="radio" name="questionType" value="í˜¼í•©í˜•" />
                  í˜¼í•©í˜• (ìœ„ ìœ í˜• ì„ì–´ì„œ)
                </label>
              </div>
            </div>
          </section>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="controls">
          <button type="button" class="btn-secondary" onclick="clearOutputs()">
            ğŸ”„ ì´ˆê¸°í™”
          </button>
          <button type="submit" class="btn-primary">
            âœ¨ ë¹„ë°€ ë…¸íŠ¸ &amp; ë¬¸ì œ ìƒì„±í•˜ê¸°
          </button>
        </div>

        <!-- ì•„ë˜ìª½ ë‘¥ê·¼ ë„¤ëª¨ ë°•ìŠ¤ -->
        <section class="card bottom-card">
          <div class="card-title">
            ğŸ’¡ ì¶œë ¥
            <span class="badge">ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸ &amp; ë¬¸ì œì§€</span>
          </div>

<div class="output-grid">
  <!-- ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸ ë°•ìŠ¤ -->
  <div class="output-box">
    <div class="output-header">
      <h2>ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸</h2>
      <button
        type="button"
        class="btn-icon"
        onclick="downloadNotePDF()"
        title="ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸ë¥¼ PDFë¡œ ì €ì¥"
      >
        ğŸ“„ PDF
      </button>
    </div>
    <textarea
      id="noteOutput"
      readonly
      placeholder="ì—¬ê¸°ì— AIê°€ ì •ë¦¬í•œ ê°•ì˜ ë…¸íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤."
    ></textarea>
  </div>

            <!-- ë¬¸ì œì§€ ë°•ìŠ¤ -->
          <div class="output-box">
              <div class="output-header">
                <h2>ë¬¸ì œì§€</h2>
                <button
                  type="button"
                  class="btn-icon"
                  onclick="downloadQuizPDF()"
                  title="ë¬¸ì œì§€ë¥¼ PDFë¡œ ì €ì¥"
                >
                  ğŸ“„ PDF
                </button>
              </div>
              <textarea
                id="quizOutput"
                readonly
                placeholder="ì—¬ê¸°ì— AIê°€ ìƒì„±í•œ ì—°ìŠµ ë¬¸ì œê°€ í‘œì‹œë©ë‹ˆë‹¤."
              ></textarea>
            </div>
          </div>
        </section>
      </form>
    </main>
  </div>

  <script>
    // â˜… í•„ìˆ˜ ìš”êµ¬ ì‚¬í•­: API ì„œë²„ ì£¼ì†Œ ìƒìˆ˜
    const SERVER_URL = "https://6725f18d-b73d-4faf-8093-2ec1d29bd274-00-2u1qx3fytvlzv.pike.replit.dev/generate_minutes"; // ë‚˜ì¤‘ì— ì‹¤ì œ ë°±ì—”ë“œ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ë©´ ë¨

    // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
    document.getElementById("lectureFile").addEventListener("change", () => {
      const fileInput = document.getElementById("lectureFile");
      const fileNameSpan = document.getElementById("fileName");

      if (fileInput.files && fileInput.files.length > 0) {
        fileNameSpan.textContent = fileInput.files[0].name;
      } else {
        fileNameSpan.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
      }
    });

    // í¼ ì œì¶œ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (í•„ìˆ˜: register í•¨ìˆ˜ ë‚´ë¶€ì— fetch POST í¬í•¨)
    function register(event) {
      event.preventDefault();
    
      const subjectName = document.getElementById("subjectName").value.trim();
      const profStyle = document.getElementById("profStyle").value.trim();
      const questionCount = parseInt(document.getElementById("questionCount").value, 10);
      const questionType =
        document.querySelector('input[name="questionType"]:checked')?.value || "";
    
      const lectureFileInput = document.getElementById("lectureFile");
      const file = lectureFileInput.files && lectureFileInput.files.length > 0
        ? lectureFileInput.files[0]
        : null;
    
      const noteOutput = document.getElementById("noteOutput");
      const quizOutput = document.getElementById("quizOutput");
    
      const formData = new FormData();
      formData.append("subjectName", subjectName);
      formData.append("profStyle", profStyle);
      formData.append("questionCount", String(questionCount));
      formData.append("questionType", questionType);
      if (file) formData.append("lectureFile", file); // âœ… íŒŒì¼ ìì²´ ì—…ë¡œë“œ
    
      fetch(SERVER_URL, {
        method: "POST",
        body: formData,
      })
        .then((response) => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then((data) => {
          noteOutput.value = data.note || "ë…¸íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";
          quizOutput.value = data.questions || "ë¬¸ì œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";
        })
        .catch((error) => {
          console.error("í†µì‹  ì˜¤ë¥˜:", error);
          noteOutput.value = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nConsole/ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸";
          quizOutput.value = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në¬¸ì œ ìƒì„± ê²°ê³¼ ì—†ìŒ";
          alert("AI ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në°±ì—”ë“œ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        });
    }


    // ì¶œë ¥ ì˜ì—­ ì´ˆê¸°í™”
    function clearOutputs() {
      document.getElementById("noteOutput").value = "";
      document.getElementById("quizOutput").value = "";
    }


  // ì¶œë ¥ ì˜ì—­ ì´ˆê¸°í™”
  function clearOutputs() {
    document.getElementById("noteOutput").value = "";
    document.getElementById("quizOutput").value = "";
  }
  
  // ê³µí†µ PDF ìƒì„± í—¬í¼ í•¨ìˆ˜ (âœ… í•œê¸€ í°íŠ¸ ì„ë² ë“œ, íƒœê·¸ ìˆ¨ê¹€, í† í° ì¤„ í•©ì¹˜ê¸°)
  function createPdfFromText(text, title, filename) {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
      alert("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      return;
    }
    if (!text || !text.trim()) {
      alert("ë¨¼ì € ë‚´ìš©ì„ ìƒì„±í•œ ë’¤ì— PDFë¡œ ì €ì¥í•´ ì£¼ì„¸ìš”!");
      return;
    }
  
    const fontBase64 = window.__KOR_FONT_BASE64__;
    if (!fontBase64) {
      alert("í•œê¸€ í°íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. NanumGothic.base64.js ë¡œë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”!");
      return;
    }
  
    const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
  
    // âœ… í•œê¸€ í°íŠ¸ ë“±ë¡ (ìœ ë‹ˆì½”ë“œ)
    doc.addFileToVFS("NanumGothic.ttf", fontBase64);
    doc.addFont("NanumGothic.ttf", "NanumGothic", "normal", "Identity-H");
    doc.setFont("NanumGothic", "normal");
  
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
  
    const M = { L: 14, R: 14, T: 18, B: 18 };
    const contentW = pageW - M.L - M.R;
  
    let y = M.T;
  
    const ensurePage = (need = 0) => {
      if (y + need > pageH - M.B) {
        doc.addPage();
        y = M.T;
      }
    };
  
    const drawWrapped = (line, x, maxW, lineH) => {
      const arr = doc.splitTextToSize(line, maxW);
      for (const w of arr) {
        ensurePage(lineH);
        doc.text(w, x, y);
        y += lineH;
      }
    };
  
    // ===============================
    // íƒœê·¸/ë§ˆí¬ë‹¤ìš´ ì •ë¦¬ ìœ í‹¸
    // ===============================
    const cleanLine = (s) => {
      let t = (s || "").trim();
  
      // ë§ˆí¬ë‹¤ìš´ í—¤ë” ì œê±° (####, ### ë“±)
      t = t.replace(/^#{1,6}\s+/, "");
  
      // ì•ìª½ ë¶ˆí•„ìš”í•œ ê¸°í˜¸ ì œê±° (íƒì§€/í‘œì‹œ ì•ˆì •)
      t = t.replace(/^â€¢\s+/, "");
  
      // [DESC] ì œê±°
      t = t.replace(/^\[DESC\]\s*/, "");
  
      // "ì •ì˜: ì •ì˜:" ê°™ì€ ì¤‘ë³µ ì œê±°
      t = t.replace(/^(ì •ì˜|íŠ¹ì§•|ì˜ˆì‹œ|ë¹„êµ|ì£¼ì˜|í™œìš©)\s*:\s*\1\s*:/, "$1:");
  
      return t;
    };
  
    // ===============================
    // âœ… í† í°(ìˆ«ì/ê¸°í˜¸) í•œ ì¤„ì”© ë–¨ì–´ì§ ë°©ì§€ ì „ì²˜ë¦¬
    // ===============================
    const normalizeLines = (lines) => {
      const out = [];
      let buf = "";
  
      const flush = () => {
        if (buf.trim()) out.push(buf.trim());
        buf = "";
      };
  
      // íƒœê·¸ ë¼ì¸ì€ ì ˆëŒ€ í•©ì¹˜ë©´ ì•ˆ ë¨
      const isTagLine = (s) => {
        const t = s.trim();
        return (
          t.startsWith("## [PART]") ||
          t.startsWith("### [SECTION]") ||
          t.startsWith("[SECTION]") ||
          t.startsWith("â—† [TERM]") ||
          t.startsWith("[DESC]") ||
          /^-\s*\[[A-Z]+\]/.test(t)
        );
      };
  
      // í† í° ë¼ì¸: ì•„ì£¼ ì§§ì€ ì¤„(ìˆ«ì/ê¸°í˜¸/ì§§ì€ ë¬¸ìì—´)ë§Œ
      const isTokenLine = (s) => {
        const t = s.trim();
        if (!t) return false;
        if (t.length > 6) return false; // ë„ˆë¬´ ê¸¸ë©´ ì¼ë°˜ ë¬¸ì¥
        // ìˆ«ì/ì˜ë¬¸/í•œê¸€/ê¸°í˜¸ ëª‡ ê°œë¡œë§Œ êµ¬ì„±ëœ ì§§ì€ ë¼ì¸
        return /^[0-9A-Za-zê°€-í£(),.=+\-*/?:]+$/.test(t);
      };
  
      for (const line of lines) {
        const t = (line || "").trimEnd();
        const tt = t.trim();
  
        // ë¹ˆ ì¤„: ë²„í¼ flush + ë¹ˆ ì¤„ ìœ ì§€
        if (!tt) {
          flush();
          out.push("");
          continue;
        }
  
        // ë§ˆí¬ë‹¤ìš´/ë¶ˆë¦¿ ì œê±°í•œ íƒì§€ìš©
        const d = tt.replace(/^#{1,6}\s+/, "").replace(/^â€¢\s+/, "");
  
        // íƒœê·¸ë©´ flush í›„ ê·¸ëŒ€ë¡œ
        if (isTagLine(d)) {
          flush();
          out.push(d);
          continue;
        }
  
        // í† í° ë¼ì¸ì´ë©´ bufì— í•©ì¹˜ê¸°
        if (isTokenLine(d)) {
          buf = buf ? (buf + " " + d) : d;
          continue;
        }
  
        // ì¼ë°˜ ë¬¸ì¥: ê¸°ì¡´ buf flush í›„ ì¶”ê°€
        flush();
        out.push(t);
      }
  
      flush();
      return out;
    };
  
    // ====== ë¬¸ì„œ ì œëª© ======
    doc.setFontSize(18);
    doc.setTextColor(20, 20, 20);
    drawWrapped(title, M.L, contentW, 8);
    y += 6;
  
    // ====== ë¼ì¸ ë¶„í•´ + ì „ì²˜ë¦¬ ======
    const rawLines = text.replace(/\r\n/g, "\n").split("\n");
    const normalizedLines = normalizeLines(rawLines);
  
    const stripPrefix = (s, prefix) =>
      s.startsWith(prefix) ? s.slice(prefix.length).trim() : s.trim();
  
    // ì—¬ë°± ì„¤ì •
    const GAP = {
      PART_BEFORE: 7,
      PART_AFTER: 4,
      SECTION_BEFORE: 5,
      SECTION_AFTER: 2.5,
      TERM_BEFORE: 2.5,
      TERM_AFTER: 1.5,
      PARA_AFTER: 2.5,
      BULLET_AFTER: 1.5,
    };
  
    // ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹
    const STYLE = {
      part:   { size: 14.8, color: [85, 55, 150], lh: 7.1, x: M.L },
      section:{ size: 12.6, color: [70, 70, 120], lh: 6.4, x: M.L + 2 },
      term:   { size: 12.2, color: [25, 25, 25],  lh: 6.2, x: M.L + 4 },
      key:    { size: 11.2, color: [70, 70, 70],  lh: 5.8, x: M.L + 10 },
      desc:   { size: 10.8, color: [15, 15, 15],  lh: 5.4, x: M.L + 10 },
      bullet: { size: 10.8, color: [15, 15, 15],  lh: 5.4, x: M.L + 12 },
      plain:  { size: 10.8, color: [15, 15, 15],  lh: 5.4, x: M.L + 6 },
    };
  
    const KEY_LABEL = {
      "[DEF]": "ì •ì˜",
      "[FEAT]": "íŠ¹ì§•",
      "[EX]": "ì˜ˆì‹œ",
      "[COMP]": "ë¹„êµ",
      "[WARN]": "ì£¼ì˜",
      "[USE]": "í™œìš©",
    };
  
    const setStyle = (st) => {
      doc.setFont("NanumGothic", "normal");
      doc.setFontSize(st.size);
      doc.setTextColor(st.color[0], st.color[1], st.color[2]);
      return st;
    };
  
    // ====== ë Œë”ë§ ======
    for (let i = 0; i < normalizedLines.length; i++) {
      const t0 = (normalizedLines[i] || "").trimEnd();
      const t = t0.trim();
  
      if (!t) {
        y += 1.5;
        continue;
      }
  
      // íƒì§€ìš© ë¬¸ìì—´(ë§ˆí¬ë‹¤ìš´/ë¶ˆë¦¿ ì œê±°)
      const d = t.replace(/^#{1,6}\s+/, "").replace(/^â€¢\s+/, "");
  
      // 1) PART
      if (d.startsWith("## [PART]")) {
        y += GAP.PART_BEFORE;
        ensurePage(12);
  
        const st = setStyle(STYLE.part);
        const content = cleanLine(stripPrefix(d, "## [PART]"));
        drawWrapped("â–  " + content, st.x, contentW - (st.x - M.L), st.lh);
  
        y += GAP.PART_AFTER;
        continue;
      }
  
      // 2) SECTION
      if (d.startsWith("### [SECTION]") || d.startsWith("[SECTION]")) {
        y += GAP.SECTION_BEFORE;
        ensurePage(10);
  
        const st = setStyle(STYLE.section);
        const prefix = d.startsWith("[SECTION]") ? "[SECTION]" : "### [SECTION]";
        const content = cleanLine(stripPrefix(d, prefix));
        drawWrapped("â–¶ " + content, st.x, contentW - (st.x - M.L), st.lh);
  
        y += GAP.SECTION_AFTER;
        continue;
      }
  
      // 3) TERM
      if (d.startsWith("â—† [TERM]")) {
        y += GAP.TERM_BEFORE;
        ensurePage(9);
  
        const st = setStyle(STYLE.term);
        const content = cleanLine(stripPrefix(d, "â—† [TERM]"));
        drawWrapped("â—† " + content, st.x, contentW - (st.x - M.L), st.lh);
  
        y += GAP.TERM_AFTER;
        continue;
      }
  
      // 4) KEY
      const keyMatch = d.match(/^-\s*(\[[A-Z]+\])\s*(.*)$/);
      if (keyMatch && KEY_LABEL[keyMatch[1]]) {
        ensurePage(8);
  
        const st = setStyle(STYLE.key);
        const label = KEY_LABEL[keyMatch[1]];
        const content = cleanLine(keyMatch[2] || "");
  
        drawWrapped(`â–¸ ${label}: ${content}`, st.x, contentW - (st.x - M.L), st.lh);
        y += 1.8;
        continue;
      }
  
      // 5) DESC
      if (d.startsWith("[DESC]")) {
        const st = setStyle(STYLE.desc);
        const content = cleanLine(stripPrefix(d, "[DESC]"));
        drawWrapped(content, st.x, contentW - (st.x - M.L), st.lh);
        y += GAP.PARA_AFTER;
        continue;
      }
  
      // 6) ì¼ë°˜ ëª©ë¡
      if (/^[*â€¢-]\s+/.test(d)) {
        const st = setStyle(STYLE.bullet);
        const content = cleanLine(d.replace(/^[*â€¢-]\s+/, ""));
        drawWrapped("â€¢ " + content, st.x, contentW - (st.x - M.L), st.lh);
        y += GAP.BULLET_AFTER;
        continue;
      }
  
      // 7) ì¼ë°˜ ë¬¸ë‹¨
      const st = setStyle(STYLE.plain);
      drawWrapped(cleanLine(t), st.x, contentW - (st.x - M.L), st.lh);
      y += 2.2;
    }
  
    // âœ… í˜ì´ì§€ ë²ˆí˜¸
    const pageCount = doc.getNumberOfPages();
    for (let p = 1; p <= pageCount; p++) {
      doc.setPage(p);
      doc.setFontSize(9);
      doc.setTextColor(140, 140, 140);
      doc.text(`${p} / ${pageCount}`, pageW - M.R, pageH - 10, { align: "right" });
    }
  
    doc.save(filename);
  }

  // âœ… ë¬¸ì œì§€ PDF ì „ìš© ìƒì„± í•¨ìˆ˜
  // - ë¬¸ì œ í˜ì´ì§€: ì •ë‹µ ìˆ¨ê¹€ + ë‹µì•ˆ ë°•ìŠ¤ í‘œì‹œ
  // - ë§ˆì§€ë§‰ í˜ì´ì§€: ì •ë‹µ ëª¨ì•„ë³´ê¸°(Answer Key) í˜ì´ì§€ ìë™ ì¶”ê°€
  function createQuizPdfFromText(text, title, filename, opts = {}) {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) {
      alert("PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      return;
    }
    if (!text || !text.trim()) {
      alert("ë¨¼ì € ë¬¸ì œë¥¼ ìƒì„±í•œ ë’¤ì— PDFë¡œ ì €ì¥í•´ ì£¼ì„¸ìš”!");
      return;
    }
  
    const fontBase64 = window.__KOR_FONT_BASE64__;
    if (!fontBase64) {
      alert("í•œê¸€ í°íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. NanumGothic.base64.js ë¡œë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”!");
      return;
    }
  
    // ì˜µì…˜
    const showAnswerBox = opts.showAnswerBox ?? true;     // ë¬¸ì œ ë°‘ì— "ë‹µì•ˆ ë°•ìŠ¤" í‘œì‹œ ì—¬ë¶€
    const addAnswerPage = opts.addAnswerPage ?? true;     // ë§ˆì§€ë§‰ì— ì •ë‹µ í˜ì´ì§€ ì¶”ê°€ ì—¬ë¶€
    const answerPageTitle = opts.answerPageTitle ?? "ì •ë‹µ ëª¨ì•„ë³´ê¸°";
    const answerBoxLines = opts.answerBoxLines ?? 3;      // ì„œìˆ í˜• ëŒ€ë¹„ ë‹µì•ˆ ë°•ìŠ¤ ì¤„ ìˆ˜(ê¸°ë³¸ 3ì¤„ ëŠë‚Œ)
  
    const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
  
    // âœ… í•œê¸€ í°íŠ¸ ë“±ë¡
    doc.addFileToVFS("NanumGothic.ttf", fontBase64);
    doc.addFont("NanumGothic.ttf", "NanumGothic", "normal", "Identity-H");
    doc.setFont("NanumGothic", "normal");
  
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
  
    const M = { L: 14, R: 14, T: 18, B: 18 };
    const contentW = pageW - M.L - M.R;
  
    let y = M.T;
  
    const ensurePage = (need = 0) => {
      if (y + need > pageH - M.B) {
        doc.addPage();
        y = M.T;
      }
    };
  
    const drawWrapped = (line, x, maxW, lineH) => {
      const arr = doc.splitTextToSize(line, maxW);
      for (const w of arr) {
        ensurePage(lineH);
        doc.text(w, x, y);
        y += lineH;
      }
    };
  
    const drawHr = () => {
      ensurePage(6);
      doc.setDrawColor(220, 220, 230);
      doc.setLineWidth(0.3);
      doc.line(M.L, y, pageW - M.R, y);
      y += 4;
    };
  
    // âœ… ë‹µì•ˆ ë°•ìŠ¤(ë¬¸ì œ í˜ì´ì§€ìš©) â€” ì •ë‹µì€ ì•ˆ ì”€
    const drawAnswerBox = () => {
      if (!showAnswerBox) return;
  
      const boxX = M.L;
      const boxW = contentW;
      const lineH = 5.5;
  
      // ë°•ìŠ¤ ë†’ì´: ì œëª©ì¤„ + ì¤„ nê°œ
      const boxH = 6 + answerBoxLines * lineH + 4;
  
      ensurePage(boxH + 6);
  
      doc.setDrawColor(210, 210, 220);
      doc.setLineWidth(0.4);
      doc.roundedRect(boxX, y, boxW, boxH, 2, 2);
  
      doc.setFontSize(10.3);
      doc.setTextColor(90, 90, 90);
      doc.text("ë‹µì•ˆ ì‘ì„±ë€", boxX + 3, y + 5);
  
      // ì¤„ ê·¸ë¦¬ê¸°
      doc.setDrawColor(225, 225, 235);
      doc.setLineWidth(0.25);
      for (let k = 1; k <= answerBoxLines; k++) {
        const yy = y + 6 + k * lineH;
        doc.line(boxX + 3, yy, boxX + boxW - 3, yy);
      }
  
      y += boxH + 7;
      doc.setTextColor(0, 0, 0);
    };
  
    // =========================
    // 1) ì œëª©
    // =========================
    doc.setFontSize(18);
    doc.setTextColor(20, 20, 20);
    drawWrapped(title, M.L, contentW, 8);
    y += 6;
  
    // =========================
    // 2) íŒŒì‹± + ë Œë”ë§ (ë¬¸ì œ í˜ì´ì§€)
    // =========================
    const rawLines = text.replace(/\r\n/g, "\n").split("\n");
  
    // ì •ë‹µ ëª¨ìœ¼ê¸°
    // answers = [{ qNum: "1", type:"ê°ê´€ì‹", answer:"..." }, ...]
    const answers = [];
  
    let inQuestion = false;
    let currentQ = null;     // { qNum, type }
    let pendingAnswer = "";  // ì •ë‹µ ë¬¸ìì—´ ëˆ„ì 
  
    const flushQuestion = () => {
      if (!inQuestion || !currentQ) return;
  
      // âœ… ë‹µì•ˆ ë°•ìŠ¤(ë¬¸ì œ í˜ì´ì§€ì— í‘œì‹œ)
      drawAnswerBox();
  
      // âœ… ì •ë‹µ ì €ì¥(ë§ˆì§€ë§‰ ì •ë‹µ í˜ì´ì§€ìš©)
      answers.push({
        qNum: String(currentQ.qNum),
        type: currentQ.type || "",
        answer: pendingAnswer.trim() || "(ì •ë‹µ ì—†ìŒ)",
      });
  
      // reset
      inQuestion = false;
      currentQ = null;
      pendingAnswer = "";
    };
  
    for (let i = 0; i < rawLines.length; i++) {
      const line = (rawLines[i] || "").trimEnd();
      const t = line.trim();
  
      if (!t) continue;
  
      // [Qn] (ìœ í˜•) ì§ˆë¬¸
      const qMatch = t.match(/^\[Q(\d+)\]\s*(?:\(([^)]+)\))?\s*(.*)$/);
      if (qMatch) {
        // ì´ì „ ë¬¸ì œ ë§ˆë¬´ë¦¬
        flushQuestion();
  
        const qNum = qMatch[1];
        const qType = (qMatch[2] || "").trim();
        const qText = (qMatch[3] || "").trim();
  
        ensurePage(18);
        y += 2;
  
        // ë¬¸ì œ í—¤ë”
        doc.setFontSize(12.8);
        doc.setTextColor(85, 55, 150);
        const head = qType ? `Q${qNum}. (${qType})` : `Q${qNum}.`;
        drawWrapped(head, M.L, contentW, 6.4);
  
        // ë¬¸ì œ ë³¸ë¬¸
        doc.setFontSize(11.2);
        doc.setTextColor(20, 20, 20);
        drawWrapped(qText, M.L + 2, contentW - 2, 6.0);
  
        y += 2.5;
        doc.setTextColor(0, 0, 0);
  
        inQuestion = true;
        currentQ = { qNum, type: qType };
        pendingAnswer = "";
        continue;
      }
  
      // ë³´ê¸° (1) (2) ...
      const choiceMatch = t.match(/^\((\d+)\)\s*(.*)$/);
      if (choiceMatch) {
        ensurePage(7);
        doc.setFontSize(10.8);
        doc.setTextColor(15, 15, 15);
  
        const idx = choiceMatch[1];
        const cText = choiceMatch[2] || "";
        drawWrapped(`  ${idx}) ${cText}`, M.L + 8, contentW - 8, 5.4);
  
        y += 0.8;
        doc.setTextColor(0, 0, 0);
        continue;
      }
  
      // ì •ë‹µ ë¼ì¸ (ë¬¸ì œ í˜ì´ì§€ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ, ì €ì¥ë§Œ)
      if (t.startsWith("ì •ë‹µ:")) {
        const a = t.replace(/^ì •ë‹µ:\s*/, "").trim();
        pendingAnswer += (pendingAnswer ? " / " : "") + a;
        continue;
      }
  
      // ê¸°íƒ€ ë¬¸ì¥ (ì§€ë¬¸/ì„¤ëª… ë“±) - ë¬¸ì œ ë³¸ë¬¸ìœ¼ë¡œ í‘œì‹œ
      ensurePage(7);
      doc.setFontSize(10.8);
      doc.setTextColor(30, 30, 30);
      drawWrapped(t, M.L + 2, contentW - 2, 5.4);
      y += 1.4;
      doc.setTextColor(0, 0, 0);
    }
  
    // ë§ˆì§€ë§‰ ë¬¸ì œ ì²˜ë¦¬
    flushQuestion();
  
    // =========================
    // 3) ì •ë‹µ í˜ì´ì§€(ë§ˆì§€ë§‰ì— ë”°ë¡œ)
    // =========================
    if (addAnswerPage) {
      doc.addPage();
      y = M.T;
  
      // ì •ë‹µ í˜ì´ì§€ ì œëª©
      doc.setFontSize(16);
      doc.setTextColor(20, 20, 20);
      drawWrapped(answerPageTitle, M.L, contentW, 8);
      y += 4;
  
      drawHr();
  
      // í‘œì²˜ëŸ¼ 2ì—´ ëŠë‚Œ(ë¬¸ì œë²ˆí˜¸/ì •ë‹µ)
      const col1W = 18; // Q ë²ˆí˜¸
      const colGap = 4;
      const col2X = M.L + col1W + colGap;
      const col2W = contentW - col1W - colGap;
  
      for (const item of answers) {
        ensurePage(10);
  
        // Q ë²ˆí˜¸
        doc.setFontSize(11.5);
        doc.setTextColor(85, 55, 150);
        doc.text(`Q${item.qNum}`, M.L, y);
  
        // ì •ë‹µ í…ìŠ¤íŠ¸
        doc.setFontSize(11);
        doc.setTextColor(30, 30, 30);
  
        // (ìœ í˜•) í‘œì‹œë„ ê°™ì´
        const label = item.type ? `(${item.type}) ` : "";
        const ansText = label + item.answer;
  
        const lines = doc.splitTextToSize(ansText, col2W);
        // ì²« ì¤„ì€ í˜„ì¬ yì—, ì´í›„ ì¤„ì€ ì¤„ë°”ê¿ˆ
        doc.text(lines[0], col2X, y);
  
        // ë‹¤ìŒ ì¤„ ì²˜ë¦¬
        const lineH = 6.0;
        for (let k = 1; k < lines.length; k++) {
          y += lineH;
          ensurePage(lineH);
          doc.text(lines[k], col2X, y);
        }
  
        y += 8;
        doc.setTextColor(0, 0, 0);
      }
    }
  
    // =========================
    // 4) í˜ì´ì§€ ë²ˆí˜¸
    // =========================
    const pageCount = doc.getNumberOfPages();
    for (let p = 1; p <= pageCount; p++) {
      doc.setPage(p);
      doc.setFontSize(9);
      doc.setTextColor(140, 140, 140);
      doc.text(`${p} / ${pageCount}`, pageW - M.R, pageH - 10, { align: "right" });
    }
  
    doc.save(filename);
  }





  // ê°•ì˜ ì •ë¦¬ ë…¸íŠ¸ PDF ë‹¤ìš´ë¡œë“œ
  function downloadNotePDF() {
    const noteText = document.getElementById("noteOutput").value;
    const subjectName =
      document.getElementById("subjectName").value.trim() || "ê³¼íƒ‘ì˜_ë¹„ë°€_ë…¸íŠ¸";

    const title = `ê³¼íƒ‘ì˜ ë¹„ë°€ ë…¸íŠ¸ - ${subjectName}`;
    const fileName = subjectName.replace(/\s+/g, "_") + "_ìš”ì•½.pdf";

    createPdfFromText(noteText, title, fileName);
  }

  // ë¬¸ì œì§€ PDF ë‹¤ìš´ë¡œë“œ
  function downloadQuizPDF() {
    const quizText = document.getElementById("quizOutput").value;
    const subjectName =
      document.getElementById("subjectName").value.trim() || "ê³¼íƒ‘ì˜_ë¹„ë°€_ë…¸íŠ¸";

    const title = `ê³¼íƒ‘ì˜ ë¹„ë°€ ë…¸íŠ¸ - ${subjectName} (ë¬¸ì œì§€)`;
    const fileName = subjectName.replace(/\s+/g, "_") + "_ë¬¸ì œì§€.pdf";

    createQuizPdfFromText(quizText, title, fileName, {
      showAnswerBox: true,   // ë¬¸ì œ ë°‘ ë‹µì•ˆ ë°•ìŠ¤ í‘œì‹œ
      addAnswerPage: true,   // ë§ˆì§€ë§‰ ì •ë‹µ í˜ì´ì§€ ì¶”ê°€
    });

  }

    
  </script>
</body>
</html>



















